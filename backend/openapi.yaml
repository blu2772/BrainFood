openapi: 3.1.0
info:
  title: BrainFood API
  description: |
    REST API für die BrainFood Vokabel-App mit FSRS-5 Spaced Repetition Algorithmus.
    
    Diese API ermöglicht die Verwaltung von Boxen, Karteikarten und die intelligente
    Wiederholungsplanung basierend auf dem FSRS-5 Algorithmus.
    
    **Authentifizierung:**
    - API Key: Temporäre Keys (60 Min) erstellt in der iOS-App
    - Der API-Key gewährt Zugriff nur auf die Daten des Users, der den Key erstellt hat
    - Verwende Format: "Bearer <api-key>" im Authorization-Header
  version: 1.0.0
  contact:
    name: BrainFood API Support

servers:
  - url: http://localhost:3000/api
    description: Local development server
  - url: https://brainfood.timrmp.de/api
    description: Production server

tags:
  - name: Boxes
    description: Box management endpoints - Create, read, update, and delete boxes
  - name: Cards
    description: Card management endpoints - Create, read, update, and delete flashcards
  - name: Reviews
    description: Spaced repetition review endpoints - Get next due cards and submit reviews
  - name: Import
    description: Import cards from PDF or text using OpenAI

security:
  - apiKeyAuth: []

components:
  securitySchemes:
    apiKeyAuth:
      type: apiKey
      in: header
      name: Authorization
      description: |
        API Key for temporary access (60 minutes). 
        Use format: "Bearer <api-key>" or use X-API-Key header.
        The API key is created by the user in the iOS app and grants access only to that user's data.

  schemas:
    Box:
      type: object
      properties:
        id:
          type: string
        userId:
          type: string
        name:
          type: string
        createdAt:
          type: string
          format: date-time

    Card:
      type: object
      properties:
        id:
          type: string
        boxId:
          type: string
        front:
          type: string
          description: Question or word to learn
        back:
          type: string
          description: Answer or translation
        tags:
          type: string
          nullable: true
          description: Comma-separated tags
        stability:
          type: number
          description: FSRS-5 stability value
        difficulty:
          type: number
          description: FSRS-5 difficulty value (0-1)
        reps:
          type: integer
          description: Number of successful repetitions
        lapses:
          type: integer
          description: Number of failures
        lastReviewAt:
          type: string
          format: date-time
          nullable: true
        due:
          type: string
          format: date-time
          description: Next due date for review
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ReviewRating:
      type: string
      enum: [again, hard, good, easy]
      description: User rating for card review

    CreateBoxRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string

    CreateCardRequest:
      type: object
      required:
        - front
        - back
      properties:
        front:
          type: string
        back:
          type: string
        tags:
          type: string
          nullable: true

    ReviewRequest:
      type: object
      required:
        - rating
      properties:
        rating:
          $ref: '#/components/schemas/ReviewRating'

    ReviewResponse:
      type: object
      properties:
        card:
          $ref: '#/components/schemas/Card'
        nextDue:
          type: string
          format: date-time
        interval:
          type: integer
          description: Interval in days

    Error:
      type: object
      properties:
        error:
          type: string

paths:
  /boxes:
    get:
      operationId: GetBoxes
      tags:
        - Boxes
      summary: Get all boxes
      description: Returns all boxes for the current user
      responses:
        '200':
          description: List of boxes
          content:
            application/json:
              schema:
                type: object
                properties:
                  boxes:
                    type: array
                    items:
                      $ref: '#/components/schemas/Box'

    post:
      operationId: CreateBox
      tags:
        - Boxes
      summary: Create a new box
      description: Creates a new box for organizing flashcards
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateBoxRequest'
      responses:
        '201':
          description: Box created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  box:
                    $ref: '#/components/schemas/Box'

  /boxes/{boxId}:
    put:
      operationId: UpdateBox
      tags:
        - Boxes
      summary: Update a box
      description: Updates the name of a box
      parameters:
        - name: boxId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateBoxRequest'
      responses:
        '200':
          description: Box updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  box:
                    $ref: '#/components/schemas/Box'

    delete:
      operationId: DeleteBox
      tags:
        - Boxes
      summary: Delete a box
      description: Deletes a box and all its cards
      parameters:
        - name: boxId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Box deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /boxes/{boxId}/cards:
    get:
      operationId: GetCards
      tags:
        - Cards
      summary: Get all cards in a box
      description: Returns all cards in a specific box, optionally filtered by search query
      parameters:
        - name: boxId
          in: path
          required: true
          schema:
            type: string
        - name: search
          in: query
          schema:
            type: string
          description: Search term to filter cards
        - name: sort
          in: query
          schema:
            type: string
            enum: [due]
          description: Sort order (by due date)
      responses:
        '200':
          description: List of cards
          content:
            application/json:
              schema:
                type: object
                properties:
                  cards:
                    type: array
                    items:
                      $ref: '#/components/schemas/Card'

    post:
      operationId: CreateCard
      tags:
        - Cards
      summary: Create a new card
      description: Creates a new flashcard in a box with initial FSRS-5 state
      parameters:
        - name: boxId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCardRequest'
      responses:
        '201':
          description: Card created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  card:
                    $ref: '#/components/schemas/Card'

  /cards/{cardId}:
    get:
      operationId: GetCard
      tags:
        - Cards
      summary: Get card details
      description: Returns detailed information about a specific card
      parameters:
        - name: cardId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Card details
          content:
            application/json:
              schema:
                type: object
                properties:
                  card:
                    $ref: '#/components/schemas/Card'

    put:
      operationId: UpdateCard
      tags:
        - Cards
      summary: Update a card
      description: Updates the front, back, or tags of a card
      parameters:
        - name: cardId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCardRequest'
      responses:
        '200':
          description: Card updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  card:
                    $ref: '#/components/schemas/Card'

    delete:
      operationId: DeleteCard
      tags:
        - Cards
      summary: Delete a card
      description: Deletes a flashcard
      parameters:
        - name: cardId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Card deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /boxes/{boxId}/reviews/next:
    get:
      operationId: GetNextReviews
      tags:
        - Reviews
      summary: Get next due cards
      description: Returns the next card(s) that are due for review based on FSRS-5 scheduling
      parameters:
        - name: boxId
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 1
          description: Maximum number of cards to return
      responses:
        '200':
          description: List of due cards
          content:
            application/json:
              schema:
                type: object
                properties:
                  cards:
                    type: array
                    items:
                      $ref: '#/components/schemas/Card'
                  count:
                    type: integer

  /cards/{cardId}/review:
    post:
      operationId: SubmitReview
      tags:
        - Reviews
      summary: Submit a card review
      description: |
        Submits a review rating for a card and updates its FSRS-5 state.
        The algorithm calculates the next due date and updates stability/difficulty values.
      parameters:
        - name: cardId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReviewRequest'
      responses:
        '200':
          description: Review processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewResponse'

  /boxes/{boxId}/stats:
    get:
      operationId: GetBoxStats
      tags:
        - Reviews
      summary: Get box statistics
      description: Returns statistics about cards and reviews in a box
      parameters:
        - name: boxId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Box statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  stats:
                    type: object
                    properties:
                      dueCount:
                        type: integer
                        description: Number of cards currently due
                      nextDue:
                        type: string
                        format: date-time
                        nullable: true
                        description: Date of next card due
                      totalCards:
                        type: integer
                      totalReviews:
                        type: integer
                      totalLapses:
                        type: integer
                      dailyReviews:
                        type: array
                        items:
                          type: object
                          properties:
                            date:
                              type: string
                              format: date-time
                            count:
                              type: integer

  /import/pdf:
    post:
      operationId: ImportCardsFromPDF
      tags:
        - Import
      summary: Import cards from PDF
      description: |
        Uploads a PDF file and uses OpenAI to automatically generate flashcards.
        The PDF text is extracted, chunked, and sent to OpenAI for card generation.
        Returns a list of created cards.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - boxId
              properties:
                file:
                  type: string
                  format: binary
                  description: PDF file to import
                boxId:
                  type: string
                  description: Target box ID
                sourceLanguage:
                  type: string
                  default: Deutsch
                  description: Source language for vocabulary
                targetLanguage:
                  type: string
                  default: Englisch
                  description: Target language for vocabulary
      responses:
        '201':
          description: Cards imported successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  cards:
                    type: array
                    items:
                      $ref: '#/components/schemas/Card'
        '400':
          description: Invalid input or file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /import/text:
    post:
      operationId: ImportCardsFromText
      tags:
        - Import
      summary: Import cards from text
      description: |
        Takes raw text and uses OpenAI to automatically generate flashcards.
        The text is chunked and sent to OpenAI for card generation.
        Returns a list of created cards.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - boxId
                - text
              properties:
                boxId:
                  type: string
                text:
                  type: string
                  description: Text content to generate cards from
                sourceLanguage:
                  type: string
                  default: Deutsch
                targetLanguage:
                  type: string
                  default: Englisch
      responses:
        '201':
          description: Cards imported successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  cards:
                    type: array
                    items:
                      $ref: '#/components/schemas/Card'
