openapi: 3.1.0
info:
  title: BrainFood API
  description: |
    REST API für die BrainFood Vokabel-App mit FSRS-5 Spaced Repetition Algorithmus.
    
    Diese API ermöglicht die Verwaltung von Boxen, Karteikarten und die intelligente
    Wiederholungsplanung basierend auf dem FSRS-5 Algorithmus.
    
    **Authentifizierung:**
    - JWT Token: Erhalten via /auth/login oder /auth/register
    - API Key: Temporäre Keys (60 Min) erstellt via /api-keys (erfordert JWT)
  version: 1.0.0
  contact:
    name: BrainFood API Support

servers:
  - url: http://localhost:3000/api
    description: Local development server
  - url: https://brainfood.timrmp.de/api
    description: Production server

tags:
  - name: Authentication
    description: User authentication and API key management
  - name: Boxes
    description: Box management endpoints
  - name: Cards
    description: Card management endpoints
  - name: Reviews
    description: Spaced repetition review endpoints
  - name: Import
    description: Import cards from PDF or text

security:
  - bearerAuth: []
  - apiKeyAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /auth/login or /auth/register
    apiKeyAuth:
      type: apiKey
      in: header
      name: Authorization
      description: |
        API Key for temporary access (60 minutes). 
        Use format: "Bearer <api-key>" or use X-API-Key header.
        Create API keys via POST /api/api-keys (requires JWT authentication).

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        email:
          type: string
        createdAt:
          type: string
          format: date-time

    Box:
      type: object
      properties:
        id:
          type: string
        userId:
          type: string
        name:
          type: string
        createdAt:
          type: string
          format: date-time

    Card:
      type: object
      properties:
        id:
          type: string
        boxId:
          type: string
        front:
          type: string
          description: Question or word to learn
        back:
          type: string
          description: Answer or translation
        tags:
          type: string
          nullable: true
          description: Comma-separated tags
        stability:
          type: number
          description: FSRS-5 stability value
        difficulty:
          type: number
          description: FSRS-5 difficulty value (0-1)
        reps:
          type: integer
          description: Number of successful repetitions
        lapses:
          type: integer
          description: Number of failures
        lastReviewAt:
          type: string
          format: date-time
          nullable: true
        due:
          type: string
          format: date-time
          description: Next due date for review
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ReviewRating:
      type: string
      enum: [again, hard, good, easy]
      description: User rating for card review

    AuthRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 6

    RegisterRequest:
      type: object
      required:
        - name
        - email
        - password
      properties:
        name:
          type: string
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 6

    AuthResponse:
      type: object
      properties:
        user:
          $ref: '#/components/schemas/User'
        token:
          type: string
          description: JWT access token

    CreateBoxRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string

    CreateCardRequest:
      type: object
      required:
        - front
        - back
      properties:
        front:
          type: string
        back:
          type: string
        tags:
          type: string
          nullable: true

    ReviewRequest:
      type: object
      required:
        - rating
      properties:
        rating:
          $ref: '#/components/schemas/ReviewRating'

    ReviewResponse:
      type: object
      properties:
        card:
          $ref: '#/components/schemas/Card'
        nextDue:
          type: string
          format: date-time
        interval:
          type: integer
          description: Interval in days

    Error:
      type: object
      properties:
        error:
          type: string

paths:
  /auth/register:
    post:
      operationId: RegisterUser
      tags:
        - Authentication
      summary: Register a new user
      description: Creates a new user account and returns a JWT token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Email already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/login:
    post:
      operationId: LoginUser
      tags:
        - Authentication
      summary: Login user
      description: Authenticates a user and returns a JWT token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/me:
    get:
      operationId: GetCurrentUser
      tags:
        - Authentication
      summary: Get current user
      description: Returns information about the currently authenticated user
      responses:
        '200':
          description: User information
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api-keys:
    post:
      operationId: CreateApiKey
      tags:
        - Authentication
      summary: Create a temporary API key
      description: |
        Creates a new temporary API key valid for 60 minutes.
        The key can be used with Custom GPT to access your boxes and cards.
        **Important:** The key is only shown once - save it immediately!
      requestBody:
        required: false
      responses:
        '201':
          description: API key created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  key:
                    type: string
                    description: The API key (save this - it won't be shown again!)
                  keyPrefix:
                    type: string
                    description: First 12 characters for identification
                  expiresAt:
                    type: string
                    format: date-time
                    description: Expiration date/time
                  message:
                    type: string
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    get:
      operationId: ListApiKeys
      tags:
        - Authentication
      summary: List all API keys
      description: Returns a list of all API keys for the current user (without the key itself)
      responses:
        '200':
          description: List of API keys
          content:
            application/json:
              schema:
                type: object
                properties:
                  keys:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        keyPrefix:
                          type: string
                        expiresAt:
                          type: string
                          format: date-time
                        createdAt:
                          type: string
                          format: date-time
                        lastUsedAt:
                          type: string
                          format: date-time
                          nullable: true

    delete:
      operationId: DeleteApiKey
      tags:
        - Authentication
      summary: Delete an API key
      description: Deletes a specific API key
      parameters:
        - name: keyId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: API key deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /boxes:
    get:
      operationId: GetBoxes
      tags:
        - Boxes
      summary: Get all boxes
      description: Returns all boxes for the current user
      responses:
        '200':
          description: List of boxes
          content:
            application/json:
              schema:
                type: object
                properties:
                  boxes:
                    type: array
                    items:
                      $ref: '#/components/schemas/Box'

    post:
      operationId: CreateBox
      tags:
        - Boxes
      summary: Create a new box
      description: Creates a new box for organizing flashcards
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateBoxRequest'
      responses:
        '201':
          description: Box created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  box:
                    $ref: '#/components/schemas/Box'

  /boxes/{boxId}:
    put:
      operationId: UpdateBox
      tags:
        - Boxes
      summary: Update a box
      description: Updates the name of a box
      parameters:
        - name: boxId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateBoxRequest'
      responses:
        '200':
          description: Box updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  box:
                    $ref: '#/components/schemas/Box'

    delete:
      operationId: DeleteBox
      tags:
        - Boxes
      summary: Delete a box
      description: Deletes a box and all its cards
      parameters:
        - name: boxId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Box deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /boxes/{boxId}/cards:
    get:
      operationId: GetCards
      tags:
        - Cards
      summary: Get all cards in a box
      description: Returns all cards in a specific box, optionally filtered by search query
      parameters:
        - name: boxId
          in: path
          required: true
          schema:
            type: string
        - name: search
          in: query
          schema:
            type: string
          description: Search term to filter cards
        - name: sort
          in: query
          schema:
            type: string
            enum: [due]
          description: Sort order (by due date)
      responses:
        '200':
          description: List of cards
          content:
            application/json:
              schema:
                type: object
                properties:
                  cards:
                    type: array
                    items:
                      $ref: '#/components/schemas/Card'

    post:
      operationId: CreateCard
      tags:
        - Cards
      summary: Create a new card
      description: Creates a new flashcard in a box with initial FSRS-5 state
      parameters:
        - name: boxId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCardRequest'
      responses:
        '201':
          description: Card created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  card:
                    $ref: '#/components/schemas/Card'

  /cards/{cardId}:
    get:
      operationId: GetCard
      tags:
        - Cards
      summary: Get card details
      description: Returns detailed information about a specific card
      parameters:
        - name: cardId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Card details
          content:
            application/json:
              schema:
                type: object
                properties:
                  card:
                    $ref: '#/components/schemas/Card'

    put:
      operationId: UpdateCard
      tags:
        - Cards
      summary: Update a card
      description: Updates the front, back, or tags of a card
      parameters:
        - name: cardId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCardRequest'
      responses:
        '200':
          description: Card updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  card:
                    $ref: '#/components/schemas/Card'

    delete:
      operationId: DeleteCard
      tags:
        - Cards
      summary: Delete a card
      description: Deletes a flashcard
      parameters:
        - name: cardId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Card deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /boxes/{boxId}/reviews/next:
    get:
      operationId: GetNextReviews
      tags:
        - Reviews
      summary: Get next due cards
      description: Returns the next card(s) that are due for review based on FSRS-5 scheduling
      parameters:
        - name: boxId
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 1
          description: Maximum number of cards to return
      responses:
        '200':
          description: List of due cards
          content:
            application/json:
              schema:
                type: object
                properties:
                  cards:
                    type: array
                    items:
                      $ref: '#/components/schemas/Card'
                  count:
                    type: integer

  /cards/{cardId}/review:
    post:
      operationId: SubmitReview
      tags:
        - Reviews
      summary: Submit a card review
      description: |
        Submits a review rating for a card and updates its FSRS-5 state.
        The algorithm calculates the next due date and updates stability/difficulty values.
      parameters:
        - name: cardId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReviewRequest'
      responses:
        '200':
          description: Review processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReviewResponse'

  /boxes/{boxId}/stats:
    get:
      operationId: GetBoxStats
      tags:
        - Reviews
      summary: Get box statistics
      description: Returns statistics about cards and reviews in a box
      parameters:
        - name: boxId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Box statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  stats:
                    type: object
                    properties:
                      dueCount:
                        type: integer
                        description: Number of cards currently due
                      nextDue:
                        type: string
                        format: date-time
                        nullable: true
                        description: Date of next card due
                      totalCards:
                        type: integer
                      totalReviews:
                        type: integer
                      totalLapses:
                        type: integer
                      dailyReviews:
                        type: array
                        items:
                          type: object
                          properties:
                            date:
                              type: string
                              format: date-time
                            count:
                              type: integer

  /import/pdf:
    post:
      operationId: ImportCardsFromPDF
      tags:
        - Import
      summary: Import cards from PDF
      description: |
        Uploads a PDF file and uses OpenAI to automatically generate flashcards.
        The PDF text is extracted, chunked, and sent to OpenAI for card generation.
        Returns a list of created cards.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - boxId
              properties:
                file:
                  type: string
                  format: binary
                  description: PDF file to import
                boxId:
                  type: string
                  description: Target box ID
                sourceLanguage:
                  type: string
                  default: Deutsch
                  description: Source language for vocabulary
                targetLanguage:
                  type: string
                  default: Englisch
                  description: Target language for vocabulary
      responses:
        '201':
          description: Cards imported successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  cards:
                    type: array
                    items:
                      $ref: '#/components/schemas/Card'
        '400':
          description: Invalid input or file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /import/text:
    post:
      operationId: ImportCardsFromText
      tags:
        - Import
      summary: Import cards from text
      description: |
        Takes raw text and uses OpenAI to automatically generate flashcards.
        The text is chunked and sent to OpenAI for card generation.
        Returns a list of created cards.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - boxId
                - text
              properties:
                boxId:
                  type: string
                text:
                  type: string
                  description: Text content to generate cards from
                sourceLanguage:
                  type: string
                  default: Deutsch
                targetLanguage:
                  type: string
                  default: Englisch
      responses:
        '201':
          description: Cards imported successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  cards:
                    type: array
                    items:
                      $ref: '#/components/schemas/Card'
